<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbon Footprint Comparison</title>
    <link rel="stylesheet" href="../styles/app_comparison-style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Include chart.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <button class="toggle-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="menu-item" onclick="navigateTo('../index.html')">
                <i class="fas fa-bolt"></i> <span class="menu-text">Energy Consumption</span>
            </div>
            <div class="menu-item" onclick="navigateTo('card.html')">
                <i class="fas fa-chart-line"></i> <span class="menu-text">Options</span>
            </div>
            <div class="menu-item" onclick="navigateTo('dashboard.html')">
                <i class="fas fa-file-alt"></i> <span class="menu-text">Dashboard</span>
            </div>
            <div class="menu-item" onclick="navigateTo('views/carbon.html')">
                <i class="fas fa-leaf"></i> <span class="menu-text">Carbon FootPrint</span>
            </div>  
            <div class="menu-item" onclick="navigateTo('about.html')">
                <i class="fas fa-leaf"></i> <span class="menu-text">About</span>
            </div>
        </div>

        <div class="content">
            <button class="back-button" onclick="goBack()">Back</button>
            <h1>Compare Footprint by Application</h1>
            <div class="select-container">
                <div class = "runtime_select"> 
                    <label for="runtime">Select Runtime</label>
                    <select id="runtime" name="runtime">
                        <option value="" disabled selected>Runtime in hrs</option>
                    </select>
                </div>
            </div>
            <div class="select-container">
                <div class = "usecase_select"> 
                    <label for="usecase">Select Use Case</label>
                    <select id="usecase" name="usecase">
                        <option value="" disabled selected>Usecase</option>
                    </select>
                </div>
            </div>

            <button id="plotButton">Plot</button>

            <div id="chart-container">
                <canvas id="heatmapChart" width="300" height="200"></canvas>
            </div>
        </div>

    </div>

    <script>
        const backendURL = "http://127.0.0.1:5000"; // Backend URL

        // DOM Elements
        const fileSelect = document.getElementById("fileSelect");
        const runtimeSelect = document.getElementById("runtime");
        const usecaseSelect = document.getElementById("usecase");
        const plotButton = document.getElementById("plotButton");
        const ctx = document.getElementById("heatmapChart").getContext("2d");

        // Chart instance
        let heatmapChart;

        async function fetchRuntimes() {
            try {
                const response = await fetch(`${backendURL}/fetch-runtimes`);
                const runtimes = await response.json();
                runtimes.forEach(runtime => {
                    const option = document.createElement("option");
                    option.value = runtime;
                    option.textContent = runtime;
                    runtimeSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error fetching runtimes:", error);
            }
        }

        async function fetchUsecases() {
            try {
                const response = await fetch(`${backendURL}/fetch-usecases`);
                const usecases = await response.json();
                usecases.forEach(usecase => {
                    const option = document.createElement("option");
                    option.value = usecase;
                    option.textContent = usecase;
                    usecaseSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error fetching usecases:", error);
            }
        }

        // Fetch heatmap data for the selected file and date range
        async function fetchHeatmapData(usecase, lower, upper) {
            try {
                console.log(`${backendURL}/generate-heatmap-usecase?usecase=${usecase}&runtime_lower=${lower}&runtime_upper=${upper}`);
                const response = await fetch(`${backendURL}/generate-heatmap-usecase?usecase=${usecase}&runtime_lower=${lower}&runtime_upper=${upper}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error fetching heatmap data:", error);
            }
        }

        function getRandomColor() {
            const r = Math.floor(Math.random() * 256);
            const g = Math.floor(Math.random() * 256);
            const b = Math.floor(Math.random() * 256);
            return `rgba(${r}, ${g}, ${b}, 0.7)`;
        }
        const colors = [
            "#FF6384", // Red
            "#36A2EB", // Blue
            "#FFCE56", // Yellow
            "#4BC0C0", // Teal
            "#9966FF", // Purple
            "#FF9F40", // Orange
            // Add more colors if needed
        ];

        // Generate heatmap chart
        function generateHeatmap(data) {
            if (!data || data.length === 0 || data.message) { // Also check for API error message
                alert("No data available or invalid response.");
                return;
            }

            //Extract labels (dates) and values (joules)
            const labels = data.map(item => item.file);
            const values = data.map(item => item.carbon_footprint);

            console.log("Labels:", labels);
            console.log("Values:", values);

            // Destroy previous chart if it exists
            if (heatmapChart) {
                heatmapChart.destroy();
            }

            // Create new chart
            heatmapChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "Carbon Footprint (grams)",
                            data: values,
                            // backgroundColor: values.map(value =>
                            //     // Adjust color mapping: Red for higher values, Green for lower
                            //     `rgba(${Math.min(value * 10, 255)}, ${255 - Math.min(value * 10, 255)}, 0, 0.7)`
                            // ),
                            //backgroundColor: labels.map(() => getRandomColor()),
                            backgroundColor: labels.map((_, index) => colors[index % colors.length]),
                            borderColor: "rgba(255, 99, 132, 1)",
                            borderWidth: 1,
                        }
                    ]
                },
                options: {
                    plugins: {
                        datalabels: {
                            color: "#000",
                            align: "end",
                            anchor: "end",
                            formatter: value => `${value.toFixed(2)} J`
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    // scales: {
                    //     x: {
                    //         title: {
                    //             display: false,
                    //             text: "Application"
                    //         }
                    //     },
                    //     y: {
                    //         beginAtZero: true,
                    //         title: {
                    //             display: false,
                    //             text: "Carbon Footprint"
                    //         }
                    //     }
                    // },
                    interaction: {
                        mode: "index",
                        intersect: false
                    },
                    maintainAspectRatio: true
                }
            });
        }


        // Handle plot button click
        plotButton.addEventListener("click", async () => {
            const selectedRange = runtimeSelect.value;
            const selectedUsecase = usecaseSelect.value;
            const [lower, upper] = selectedRange.split('-').map(Number);

            if (selectedUsecase && selectedRange) {
                const heatmapData = await fetchHeatmapData(selectedUsecase, lower, upper);
                generateHeatmap(heatmapData);
            } else {
                alert("Please select a file and a valid runtime range.");
            }
        });

        // Initialize   
        fetchRuntimes();  
        fetchUsecases();         
            
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function navigateTo(path) {
            window.location.href = path;
        }
        function goBack() {
        window.history.back();
        }
        </script>
</body>
</html>
